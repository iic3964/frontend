---
import MetricsDashboard from "../components/metrics/MetricsDashboard.jsx";
import Card from "../components/UI/Card.astro";
import BaseLayout from "../layouts/Base.astro";
---

<script is:inline>
  (function() {
    const sessionStr = localStorage.getItem("saluia.session");

    if (!sessionStr) {
      window.location.href = "/auth/login";
      return;
    }

    try {
      const session = JSON.parse(sessionStr);
      const role = session.user?.user_metadata?.role;

      document.addEventListener("DOMContentLoaded", () => {
        const adminBlock = document.getElementById("admin-actions");
        const metricsButton = document.getElementById("metrics-button");

        if (role === "admin" && adminBlock) {
          adminBlock.classList.remove("hidden");
        }

        // Mostrar botÃ³n de mÃ©tricas para supervisores y admins
        if ((role === "supervisor" || role === "admin") && metricsButton) {
          metricsButton.classList.remove("hidden");
        }
      });
    } catch (e) {
      localStorage.removeItem("saluia.session");
      window.location.href = "/auth/login";
    }
  })();
</script>

<BaseLayout title="SaluIA â€” Inicio">
  <div class="space-y-6">
    {/* Actions Section */}
    <Card>
      <div class="p-6 md:p-8 flex flex-col items-center gap-6 text-center">
        <div>
          <h2 class="text-2xl font-semibold mb-2 text-health-text">Acciones RÃ¡pidas</h2>
          <p class="text-health-text-muted text-sm">
            Selecciona una opciÃ³n para gestionar episodios
          </p>
        </div>

        {/* Metrics Button (Solo para supervisores/admins) */}
        <a
          id="metrics-button"
          href="/admin/metrics"
          class="hidden w-full max-w-lg rounded-2xl bg-gradient-to-r from-health-accent to-health-secondary text-white py-4 text-lg font-medium text-center transition hover:shadow-lg hover:scale-[1.02] border border-health-accent/30"
        >
          ðŸ“Š Ver MÃ©tricas de Todo el Equipo
        </a>

        {/* Standard Actions (Fila 1) */}
        <div class="grid gap-4 sm:grid-cols-2 w-full max-w-lg">
          <a
            href="/clinical_attentions"
            class="rounded-2xl bg-health-accent text-white py-5 text-lg font-medium text-center transition hover:bg-health-accent-dark shadow-md"
          >
            Ver Episodio Clinicos
          </a>
          <a
            href="/send"
            class="rounded-2xl bg-health-secondary text-white py-5 text-lg font-medium text-center transition hover:bg-health-secondary-dark shadow-md"
          >
            Crear Episodio Clinico
          </a>
        </div>

        {/* Admin Actions (Fila 2) - Oculto por defecto, mismo Grid */}
        <div
          id="admin-actions"
          class="hidden grid gap-4 sm:grid-cols-2 w-full max-w-lg"
        >
          <a
            href="/admin/patients"
            class="rounded-2xl bg-health-accent text-white py-4 text-base font-medium text-center transition hover:bg-health-accent-dark shadow-lg"
          >
            Ver Pacientes
          </a>
          <a
            href="/admin/users/"
            class="rounded-2xl bg-health-secondary text-white py-4 text-base font-medium text-center transition hover:bg-health-secondary-dark shadow-lg"
          >
            Ver Usuarios
          </a>
        </div>
      </div>
    </Card>

    {/* MÃ©tricas Dashboard */}
    <Card>
      <div class="p-6 md:p-8">
        <MetricsDashboard client:load />
      </div>
    </Card>
  </div>
</BaseLayout>
